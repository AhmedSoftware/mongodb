<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi"
     xmlns:util="http://schemas.microsoft.com/wix/UtilExtension">
  <Product Id="$(var.ProductId)" 
           Name="!(wix.ProductName)" 
           Language="1033" 
           Version="$(var.MerizoDBVersion)" 
           Manufacturer="MerizoDB Inc." 
           UpgradeCode="$(var.UpgradeCode)">

    <Package InstallerVersion="405" Compressed="yes" Platform="x64"/>

    <WixVariable Id="InstallFolder" Value="$(var.MerizoDBMajorVersion)"/>

    <?if $(var.Edition) = Enterprise ?>
        <WixVariable Id="ProductName" Value="MerizoDB $(var.MerizoDBVersion) $(var.Flavor) Enterprise (64 bit)" />
        <WixVariable Id="ProductMajorName" Value="MerizoDB $(var.MerizoDBMajorVersion) $(var.Flavor) Enterprise (64 bit)" />
    <?elseif $(var.Edition) = SSL ?>
        <WixVariable Id="ProductName" Value="MerizoDB $(var.MerizoDBVersion) $(var.Flavor) SSL (64 bit)" />
        <WixVariable Id="ProductMajorName" Value="MerizoDB $(var.MerizoDBMajorVersion) $(var.Flavor) SSL (64 bit)" />
    <?else?>
        <WixVariable Id="ProductName" Value="MerizoDB $(var.MerizoDBVersion) $(var.Flavor) (64 bit)" />
        <WixVariable Id="ProductMajorName" Value="MerizoDB $(var.MerizoDBMajorVersion) $(var.Flavor) (64 bit)" />
    <?endif?>

    <MajorUpgrade
      DowngradeErrorMessage="A later version of [ProductName] is already installed. Setup will now exit."/>

    <Directory Id="TARGETDIR" Name="SourceDir">
        <Directory Id="ProgramFiles64Folder">
            <Directory Id="MerizoDB" Name="MerizoDB">
                <Directory Id="Server" Name="Server">
                    <Directory Id="INSTALLLOCATION" Name="!(wix.InstallFolder)">
                      <Directory Id="BIN" Name="bin" />
                        <Directory Id="MERIZO_DATA_PATH" Name="data" />
                        <Directory Id="MERIZO_LOG_PATH" Name="log" />
                      <Directory Id="SNMP" Name="snmp" />
                    </Directory>
                </Directory>
            </Directory>
        </Directory>
        <Directory Id="CommonAppDataFolder">
            <Directory Id="MerizoDBData" Name="MerizoDB">
                <Directory Id="ServerData" Name="Server">
                    <Directory Id="VersionData" Name="!(wix.InstallFolder)" />
                </Directory>
            </Directory>
        </Directory>
    </Directory>

    <Binary Id="CAIntro" SourceFile="$(var.CustomActionDll)"/>

    <CustomAction Id="UpdateMerizoYAML"
        BinaryKey="CAIntro"
        DllEntry="UpdateMerizoYAML"
        Execute="deferred"
        Return="check"
        Impersonate="no"
        HideTarget="no" />

    <CustomAction Id="UpdateMerizoYAML.SetProperty" 
        Return="check"
        Property="UpdateMerizoYAML"
        Value="BIN=[BIN];MERIZO_DATA_PATH=[MERIZO_DATA_PATH];MERIZO_LOG_PATH=[MERIZO_LOG_PATH]"/>

    <CustomAction Id="ValidateServiceLogon"
        BinaryKey="CAIntro"
        DllEntry="ValidateServiceLogon"
        Execute="immediate" />

    <InstallExecuteSequence>
      <Custom Action="UpdateMerizoYAML.SetProperty" Before="InstallFiles" />
      <Custom Action="UpdateMerizoYAML" After="InstallFiles">MERIZO_SERVICE_INSTALL AND NOT REMOVE</Custom>
    </InstallExecuteSequence>
  
    <Media Id="1" Cabinet="media1.cab" EmbedCab="yes" />
    <WixVariable Id="WixUIDialogBmp" Value="$(var.ProjectDir)Dialog.bmp" />
    <WixVariable Id="WixUIBannerBmp" Value="$(var.ProjectDir)Banner.bmp" />
    <WixVariable Id="WixUIInfoIco" Value="$(var.ProjectDir)Installer_Icon_32x32.ico" />
    <WixVariable Id="WixUIExclamationIco" Value="$(var.ProjectDir)Installer_Icon_32x32.ico" />

    <Property Id="ARPPRODUCTICON" Value="MerizoDBIcon" />
    <Property Id="ARPHELPLINK" Value="http://www.merizodb.org/" />
    <Property Id="ARPURLINFOABOUT" Value="http://www.merizodb.org/" />

    <Icon Id="MerizoDBIcon" SourceFile="$(var.ProjectDir)Installer_Icon_32x32.ico" />
    <Binary Id="MerizoDBIconBinary" SourceFile="$(var.ProjectDir)Installer_Icon_32x32.ico" />

    <FeatureGroupRef Id="fg_MerizoDBAll" />

    <UIRef Id="MerizoWixUI" />
    <UIRef Id="WixUI_ErrorProgressText" />
    <Property Id="WIXUI_INSTALLDIR" Value="INSTALLLOCATION" />

    <!-- Settings for Install MerizoDB as a service -->
    <Property Id="MERIZO_SERVICE_INSTALL" Value="0" Secure="yes" />
    <Property Id="MERIZO_SERVICE_ACCOUNT_TYPE" Secure="yes" Value="ServiceLocalNetwork" />
    <Property Id="MERIZO_SERVICE_NAME" Secure="yes" Value="MerizoDB" />
    <Property Id="MERIZO_SERVICE_ACCOUNT_DOMAIN" Value="." />
    <Property Id="MERIZO_SERVICE_ACCOUNT_NAME" Secure="yes" Value="MerizoDB" />
    <Property Id="MERIZO_SERVICE_ACCOUNT_PASSWORD" Secure="yes" Hidden="yes"/>

    <Property Id="MERIZO_DATA_PATH" Secure="yes" />
    <Property Id="MERIZO_LOG_PATH" Secure="yes" />

    <util:Group Id="PerfmonGroup" Name="Performance Monitor Users" />

    <!-- 
        Setup the domain to use for granting permissions, the gotcha is the local machine.
        The util:User element wants an empty string for the domain for the local machine.
        The ServiceInstall element wants '.' for the domain for the local machine.
    -->
    <!-- Default the domain to grant to the user request -->
    <CustomAction Id="MerizoDB.SetGrantAccountDefault"
        Property="MERIZO_SERVICE_ACCOUNT_DOMAIN_GRANT" Value="[MERIZO_SERVICE_ACCOUNT_DOMAIN]" />

    <!-- Change the domain to blank if the user specified '.' i.e. local machine -->
    <CustomAction Id="MerizoDB.SetGrantAccountToBlank"
        Property="MERIZO_SERVICE_ACCOUNT_DOMAIN_GRANT" Value="" />

    <!-- Change the domain to blank if the user specified '.' i.e. local machine -->
    <CustomAction Id="MerizoDB.SetGrantAccountToNetworkAccount"
        Property="MERIZO_SERVICE_ACCOUNT_DOMAIN_GRANT" Value="NT AUTHORITY" />

    <!-- Default to the fully qualified domain\account for the service account -->
    <CustomAction Id="MerizoDB.SetServiceAccountDefault"
        Property="MERIZO_SERVICE_FULL_ACCOUNT_NAME"
        Value="[MERIZO_SERVICE_ACCOUNT_DOMAIN]\[MERIZO_SERVICE_ACCOUNT_NAME]" />

    <!-- Default to .\account if the user left domain blank -->
    <CustomAction Id="MerizoDB.SetServiceAccountToDot"
        Property="MERIZO_SERVICE_FULL_ACCOUNT_NAME" Value=".\[MERIZO_SERVICE_ACCOUNT_NAME]" />

    <!-- If the user chose network service, then just set the user account to Network Service -->
    <CustomAction Id="MerizoDB.SetServiceNetworkAccount"
        Property="MERIZO_SERVICE_FULL_ACCOUNT_NAME" Value="NT AUTHORITY\NetworkService" />
    <CustomAction Id="MerizoDB.SetServiceNetworkAccount2"
        Property="MERIZO_SERVICE_ACCOUNT_NAME" Value="NetworkService" />

    <InstallExecuteSequence>
        <Custom Action="MerizoDB.SetGrantAccountDefault" After="CostFinalize" />
        <Custom Action="MerizoDB.SetGrantAccountToBlank" After="CostFinalize">MERIZO_SERVICE_ACCOUNT_DOMAIN = "."</Custom>
        <Custom Action="MerizoDB.SetGrantAccountToNetworkAccount" After="CostFinalize">MERIZO_SERVICE_ACCOUNT_TYPE = "ServiceLocalNetwork"</Custom>

        <Custom Action="MerizoDB.SetServiceAccountDefault" After="CostFinalize" />
        <Custom Action="MerizoDB.SetServiceAccountToDot" After="CostFinalize">MERIZO_SERVICE_ACCOUNT_DOMAIN = ""</Custom>
        <Custom Action="MerizoDB.SetServiceNetworkAccount" After="CostFinalize">MERIZO_SERVICE_ACCOUNT_TYPE = "ServiceLocalNetwork"</Custom>
        <Custom Action="MerizoDB.SetServiceNetworkAccount2" After="CostFinalize">MERIZO_SERVICE_ACCOUNT_TYPE = "ServiceLocalNetwork"</Custom>
    </InstallExecuteSequence>

    <Property Id="MERIZO_MULTIPLE_SKU" >
        <RegistrySearch Id="Merizo_Multiple_Sku"
            Root="HKLM"
            Key="Software\MerizoDB\Server\$(var.MerizoDBMajorVersion)"
            Name="Edition"
            Type="raw" />
    </Property>

    <Condition Message="You cannot install multiple editions for the same version of MerizoDB. Already installed product '[MERIZO_MULTIPLE_SKU]' conflicts with this product.">
        Installed OR (NOT MERIZO_MULTIPLE_SKU OR MERIZO_MULTIPLE_SKU = "!(wix.ProductMajorName)")
    </Condition>

    <Property Id="SHOULD_INSTALL_COMPASS" Secure="yes" Value="1" />

    <Property Id="POWERSHELLVERSION">
      <RegistrySearch
          Id="POWERSHELLVERSION"
          Type="raw"
          Root="HKLM"
          Key="SOFTWARE\Microsoft\PowerShell\3\PowerShellEngine\PowerShellVersion"
          Name="Path" />
    </Property>
    <Condition Message="You must have PowerShell 3.0 or higher.">
      <![CDATA[Installed OR POWERSHELLVERSION >= 3.0]]>
    </Condition>

    <Property Id="POWERSHELLEXE">
      <RegistrySearch
          Id="POWERSHELLEXE"
          Type="raw"
          Root="HKLM"
          Key="SOFTWARE\Microsoft\PowerShell\1\ShellIds\Microsoft.PowerShell"
          Name="Path" />
    </Property>

    <SetProperty
        Id="InstallCompassScript"
        Before="InstallCompassScript"
        Sequence="execute"
        Value ="&quot;[POWERSHELLEXE]&quot; -NoLogo -NoProfile -NonInteractive -ExecutionPolicy Bypass -Command &quot;&amp; '[#InstallCompassScript]' ; exit $$($Error.Count)&quot;" />

    <CustomAction
        Id="InstallCompassScript"
        BinaryKey="WixCA"
        DllEntry="WixQuietExec64"
        Execute="deferred"
        Return="ignore"
        Impersonate="yes" />

    <InstallExecuteSequence>
      <Custom Action='InstallCompassScript' After='InstallFiles'>
        (NOT Installed) AND (SHOULD_INSTALL_COMPASS = 1)
      </Custom>
    </InstallExecuteSequence>

  </Product>
</Wix>
